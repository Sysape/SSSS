[% INCLUDE header.tmpl %]
	<a href="/ssnewform.pl" target="_blank"> New </a>
[% INCLUDE sql.tmpl %]
	<form action="/ssss.pl" method="get">
	<table border=1 width="100%">
		<tr>
		<th></th>
		[% FOREACH item = column %]	
			<th> [% item %] </th> 
    	[% END %]
			<th> Comments </th>
		</tr>
		<tr>
		<td></td>
		[% FOREACH item = column %]	
			<td> 
				<INPUT type="radio" name="order" value="[% item %] ASC"
				[% IF parms.order == "$item ASC" %]
					checked
				[% END %]
				> u
				<br>
			 	<INPUT type="radio" name="order" value="[% item %] DESC"
				[% IF parms.order == "$item DESC" %]
					checked
				[% END %]
				> d
				<input type="submit" value="do it!">
			</td> 
    	[% END %]
		<td></td>
		</tr>

        <tr>
		<td></td>
        [% FOREACH thingy = column %]
            <td> 
			[% IF like.grep(thingy).0 %]
			<input type="text" size=[% thingy.length * 2 %] name="$thingy"
				[% IF parms.$thingy %]
					value="[% parms.$thingy %]"
				[% END %]
			>
			[% ELSE %]	
			<select name="$thingy">
				<option>ALL</option>
				[% IF thingy == "stage" %]
					<option
						[% IF parms.$thingy == 'ACTIVE' %]
							selected
						[% END %]
					>ACTIVE</option>
				[% END %]	
            	[% FOREACH cell = 
					DBI.query("SELECT DISTINCT $thingy FROM customer") %]
                    [% values = cell.list('values') %]
					[% FOREACH value = values %]
                		<option
							[% IF parms.$thingy == value %]
								selected
							[% END %]
						>$value</option>
					[% END %]
				[% END %]
			[% END %]
			</select>
            </td>
        [% END %]
		<td></td>
		</tr>
		[% main = DBI.prepare(sql) %] 
		[% bind = [] %]
		[% FOREACH actives = active %]
			[% IF like.grep(actives).0 %]
				[% likact = parms.$actives %]
				[% bind.push("\%$likact\%") %]
			[% ELSE %]
				[% IF parms.$actives == 'ACTIVE' %] 
					[% bind.push('quote') %]
					[% bind.push('first') %]
					[% bind.push('happen') %]
				[% ELSE %]	
					[% bind.push(parms.$actives) %]
				[% END %]
			[% END %]
		[% END %]
		[% FOREACH customer = main.execute(bind) %]
		<tr>
			<td><a href=/ssnewform.pl?id=[%customer.id%] target="_blank"> edit </a></td>
			[% FOREACH item = column %]
				[% IF item == 'email' ;
					text = customer.$item.substr(0, 13) %]
					<td><a href=mailto:[%customer.$item%]> $text </a></td>
				[% ELSE %]
  					<td>[% customer.$item %]</td>
				[% END %]
			[% END %]
			[% comments = DBI.prepare
				("SELECT * FROM comment WHERE custid = $customer.id") %] 
				[% com = [ some, shit ] %]
				[% FOREACH comment = comments.execute %]
					[% com.push("$comment.date : $comment.comment <br>") %]
				[% END %]
				[% output = com.join(' ') %]
				[% num = output.length - 50 %]
				<td>
				[%IF num > 0 %]
					[% output.substr(num) %]
				[% ELSE %]
					$output
				[% END %]
				</td>
			</tr>
		[% END %]
	</table>
	</form>
	<div id="footer">
  	<div id="copyright">
    		&copy; [% copyright %]
  	</div>
	</div>
</body>
</html>
