[% INSERT header.start.tmpl %]
[%# This is the main table page of the ssss, we start by including the
files that go to make up the header for this doc we need header.start
jquery.ssss sql and header.end
%]
<!-- the jquery stuff we need to make the page behave nicely --!>
[% INCLUDE jquery.ssss.tmpl %]
<!-- make connection to the database so we can read/write to it --!>
    [% USE DBI( database = 'dbi:mysql:solsystest',
        username = 'solsys' ,
        password = 'w0kk4' )
    %]
<!-- and the bottom of the header --!>
[% INSERT header.end.tmpl %]
<!-- this is wrong, dunno quite how to do new tings yet
	<a href="/ssnewform.pl" target="_blank"> New </a>
--!>
	<!-- the start of the form that limits the selection of clients from 
		the db. --!>
	<table border=1 width="100%">
	<form action="/cgi-bin/ssss.pl" method="get">
		<tr>
		[% FOREACH column = columns %]	
			<th> [% column %] </th> 
    	[% END %]
		</tr>
		<tr>
		[% FOREACH column = columns %]	
			<td> 
				<INPUT type="radio" name="order" value="[% column %] ASC"
				[%- IF parms.order == "$column ASC" -%]
					checked
				[%- END -%]
				> u
				<br>
			 	<INPUT type="radio" name="order" value="[% column %] DESC"
				[%- IF parms.order == "$column DESC" -%]
					checked
				[%- END -%]
				> d
				<input type="submit" value="do it!">
			</td> 
    	[% END %]
		</tr>

        <tr>
        [% FOREACH column = columns %]
            <td> 
			[% IF like.grep(column).0 %]
			<input type="text" size=[% column.length * 2 %] name="$column"
				[%- IF parms.$column -%]
					value="[% parms.$column %]"
				[% END %]
			>
			[% ELSE %]	
			<select name="$column">
				<option>ALL</option>
				[% IF column == "stage" %]
					<option
						[%- IF parms.$column == 'ACTIVE' -%]
							selected
						[%- END -%]
					>ACTIVE</option>
				[% END %]	
            	[% FOREACH cell = 
					DBI.query("SELECT DISTINCT $column FROM customer") %]
                    [% values = cell.list('values') %]
					[% FOREACH value = values %]
                		<option
							[%- IF parms.$column == value -%]
								selected
							[%- END -%]
						>$value</option>
					[% END %]
				[% END %]
			[% END %]
			</select>
            </td>
        [% END %]
		</form>
		</tr>
		<!-- start the form out side the loop --!>	
		<form action="/cgi-bin/ssss.pl" method="post">
		[% FOREACH customer = customers %]
		<tr class="norm">
			[% FOREACH column = columns %]
				[% IF column == 'email' ;
					text = customer.$column.substr(0, 13) %]
					<td><a href=mailto:[%customer.$column%]>$text</a></td>
				[% ELSE %]
  					<td>
					[% customer.$column %] 
					</td>
				[% END %]
			[% END %]
		</tr>
		<tr class="edit">
			<td colspan="12">
			<!-- add a close div with and X in it, so clicking the X
			closes the open pane with js --!>
			<div class='close'>X</div>
			<div id ='[%customer.id%]tabs'>
				<ul>
					<li><a href="#[%customer.id%]tabs-1">Main</a></li>
					<li><a href="#[%customer.id%]tabs-2">Comments</a></li>
					<li><a href="#[%customer.id%]tabs-3">Project Manglement</a></li>
					<li><a href="#[%customer.id%]tabs-4">Attachments</a></li>
				</ul>

				<div id='[%customer.id%]tabs-1'>
				<!-- Show the ID so people can read it, we don't need to pass
				this to the cgi as it's used as part of the name for the
				relevant fields. To mkae life easier no field names can start
				with a number so that ^[0-9]+ matches the key on the front on
				the field name. --!>
				ID: [% customer.id %]  
				<!-- we need to have the label and the <input> on the same line
				so we use some <span>s --!>
				<span style="white-space: nowraps;">
				Action Date (YYYY-MM-DD): <input type="text" size=10
					name="cust[% customer.id %]actdate"
					value='[% customer.actdate %]'>
				</span>
				<span style="white-space: nowraps;">
				Name (50): <input type="text" size=50
					name="cust[% customer.id %]name"
				 	value="[% customer.name %]" />	
				</span>
				<span style="white-space: nowraps;">
				Address (250): <textarea name="cust[% customer.id %]address"
					rows=5 cols=50>[% customer.address %]</textarea>
				</span>
				<span style="white-space: nowraps;">
				Phone (50): <input type="text" size=50
					name="cust[% customer.id %]phone"
				 	value="[% customer.phone %]"/>
				</span>
				<span style="white-space: nowraps;">
				Email (50): <input type="text" size=50
					name="cust[% customer.id %]email"
				 	value="[% customer.email %]"/>
				</span>
				<span style="white-space: nowraps;">
				Reference (5): <input type="text" size=5
					name="cust[% customer.id %]reff"
				 	value="[% customer.reff %]"/>
				</span>
				<span style="white-space: nowraps;">
				Grant Type : <select name="cust[% customer.id %]grantype">
							<option></option>
								<option [% IF customer.grantype == 'st1' -%]
										selected="selected"
										[%- END -%]
								>st1</option>
								<option [% IF customer.grantype == 'st2' -%]
										selected="selected"
										[%- END -%]
								>st2</option>
								<option [% IF customer.grantype == 'ph2' -%]
										selected="selected"
										[%- END -%]
								>ph2</option>	
							</select> 
				</span>
				<span style="white-space: nowraps;">
				Lead: (5): <input type="text" size=5
					name="cust[% customer.id %]lead"
				 	value="[% customer.lead %]">
				</span>
				<span style="white-space: nowraps;">
				First Contact (YYYY-MM-DD): <input type="text" size=10
					name="cust[% customer.id %]first"
				 	value="[% customer.first %]">
				</span>
				<span style="white-space: nowraps;">
				Stage: <select name="cust[% customer.id %]stage">
								<option [% IF  customer.stage == 'first' -%]
										selected="selected"
										[%- END -%]
								>first</option>
								<option [% IF  customer.stage == 'quote' -%]
										selected="selected"
										[%- END -%]
								>quote</option>
								<option [% IF  customer.stage == 'happen' -%]
										selected="selected"
										[%- END -%]
								>happen</option>	
								<option [% IF  customer.stage == 'lost' -%]
										selected="selected"
										[%- END -%]
								>lost</option>	
								<option [% IF  customer.stage == 'completed' -%]
										selected="selected"
										[%- END -%]
								>completed</option>	
							</select>
				</span>
				<span style="white-space: nowraps;">
				Assigned to : <select name="cust[% customer.id %]assign">
								<option></option>
								<option [% IF  customer.assign == 'rich' -%]
										selected="selected"
										[%- END -%]
								>rich</option>
								<option [% IF  customer.assign == 'mik' -%]
										selected="selected"
										[%- END -%]
								>mik</option>
								<option [% IF  customer.assign == 'rob' -%]
										selected="selected"
										[%- END -%]
								>rob</option>	
								<option [% IF  customer.assign == 'raj' -%]
										selected="selected"
										[%- END -%]
								>raj</option>	
							</select>
				</span>
				<BR>
            	<INPUT type="submit" value="Do IT!">
				<a href="">Delete me!</a>
				</div>
				<div id='[%customer.id%]tabs-2'>
					[%# step through the comments handed by the cgi -%]
					[%- FOREACH comment = comments -%]
					[%- NEXT UNLESS comment.custid == customer.id -%]
					 	Comment (500):  
						<textarea name="comm[% comment.id %]comment" cols=125
						rows=3>[% comment.comment %]</textarea>
					 	Date (YYYY-MM-DD): 
			 			<input type="text" size=10 name="comm[% comment.id %]date"
						value="[% comment.date %]">
						<a href="/sscomsure.pl?id=[% comment.id %]">
							Delete me!</a>
					[% END %]
					 Comment (500):  
					<textarea name="newcomment" cols=125 rows=3></textarea>
					 Date (YYYY-MM-DD): 
					<input type="text" size=10 name="newdate" value="$today">
				</div>
				<div id='[%customer.id%]tabs-3'>
					Some guff!
				</div>
				<div id='[%customer.id%]tabs-4'>
					Filez
				</div>
			</div>
			</td>
		</tr>
		[% END %]
		<tr>	
			<td colspan='4'>
			NEW <Br>
			Action Date (YYYY-MM-DD): <input type="text" size=10
				name="newactdate"><BR>
			Name (50): <input class="foo" type="text" size=50 name="newname"/><BR>
			Address (250):
				 <textarea name="newaddress" rows=5 cols=50></textarea> <BR>
			Phone (50): <input type="text" size=50 name="newphone"/> <BR>
			Email (50): <input type="text" size=50 name="newemail"/> <BR>	
			</td><td colspan="0">
			Reference (5): <input type="text" size=5 name="newreff"/> <BR>
			Grant Type : <select name="newgrantype">
							<option></option>
							<option>st1</option>
							<option>st2</option>
							<option >ph2</option>	
						</select> <BR>
			Lead: (5): <input type="text" size=5 name="newlead"/> <BR>
			First Contact (YYYY-MM-DD): <input type="text" size=10
				name="newfirst"/><BR>
			Stage: <select name="newstage">
							<option selected="selected">first</option>
							<option>quote</option>
							<option>happen</option>	
							<option>lost</option>	
							<option>completed</option>	
						</select> <BR>
			Assigned to : <select name="newassign">
							<option></option>
							<option>rich</option>
							<option>mik</option>
							<option>rob</option>
							<option>raj</option>
						</select>
			</td>
			<td> <INPUT type="submit" value="Do IT!"> </td>
		<tr>
		</form>
	</table>
	<div id="footer">
  	<div id="copyright"	>
    		&copy; [% copyright %]
  	</div>
	</div>
	<!-- disconnect from database, to stop error --!>
	[% DBI.disconnect %] 
</body>
</html>
